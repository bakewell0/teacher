var vm=new Vue({el:"#app",data:{tabIndex:0,url:"{folio_id}",range:0,portfolio:{},analysisTab:[{name:"Portfolio Optimization"},{name:"Basic Chart"},{name:"AI Forecast"},{name:"Style Analysis"},{name:"Ratios"},{name:"Risk/Return Attribution"}],optimization:{},risk_fun:"var",basic:{},ai:{},style:{},benchmark:{},ratios:{},risk:{},aiRegime:"Model One",aiFactor:"BTC Factor",nTrials:100,styleFactor:"BTC Factor",percentile:0,opacity:1,loading:!1,frontier:null},methods:{switchTab(t){this.tabIndex=t},share(){},follow(){},confirmRemove(t){this.$confirm("Do you want to delete this portfolio?","",{confirmButtonText:"YES",cancelButtonText:"NO",type:"warning",center:!0}).then(()=>{this.removeMyPortfolio(t)}).catch(()=>{})},removeMyPortfolio(t){axios.get(window.reqUrl+"/delete/portfolio/"+t,{params:{token:localStorage.getItem("token")}}).then(t=>{0==t.data.error&&(location.href="index.html")}).catch(function(t){console.log(t)})},pie(){var t=[["portfolio","5"]];this.portfolio.allocations.forEach(a=>{var e=[a.coin_name,parseFloat(a.weight)];t.push(e)});var a=google.visualization.arrayToDataTable(t);new google.visualization.PieChart(document.getElementById("pie")).draw(a,{slices:{4:{offset:.2},12:{offset:.3},14:{offset:.4},15:{offset:.5}},height:250})},drawChart(){for(var t=[["litecoin","5"]],a=0;a<this.optimization.K;a++){var e=[this.optimization.Coins[a].Name,this.optimization.Frontier[this.range][0][a]];t.push(e)}var i=google.visualization.arrayToDataTable(t);new google.visualization.PieChart(document.getElementById("piechart")).draw(i,{slices:{4:{offset:.2},12:{offset:.3},14:{offset:.4},15:{offset:.5}},height:300})},frontierAllocs(){for(var t=[],a=["Portfolio"],e=0;e<this.optimization.K;e++)a.push(this.optimization.Coins[e].Name);t.push(a);for(e=0;e<this.optimization.N;e++){var i=[];i.push(e);for(var o=0;o<this.optimization.K;o++)i.push(this.optimization.Frontier[e][0][o]);t.push(i)}var s=google.visualization.arrayToDataTable(t);new google.visualization.AreaChart(document.getElementById("frontier_alloc_chart")).draw(s,{title:"Frontier Allocations",chartArea:{left:"10%",right:"5%",top:"10%",bottom:"10%",width:"100%"},legend:{position:"bottom"},vAxis:{format:"0.00%",title:"weight"},height:450,isStacked:"relative",width:1140})},frontier_chart(){for(var t=[["Risk "+this.optimization.Fun,"Return",{type:"string",role:"style"}]],a=0;a<this.optimization.N;a++){var e=this.optimization.Frontier,i=this.optimization.AnnFactor,o=[];o="var"==this.optimization.Fun?[e[a][2]*i**.5,e[a][1]*i]:[e[a][2],e[a][1]*i],a==this.optimization.MaxSharpeIDx?o.push("point { size: 10; shape-type: star; fill-color: #f39800; }"):this.optimization.N-1?o.push("point { size: 5; shape-type: diamond; fill-color: #1e5adc; }"):o.push("point { size: 5; shape-type: circle; fill-color: #1e5adc; }"),t.push(o)}var s=new google.visualization.arrayToDataTable(t),r={title:"Efficient Frontier",legend:{position:"none"},vAxis:{format:"0%",title:"Annualized Return",textPosition:"in"},hAxis:{format:"0%",title:"Annualized Risk"},chartArea:{left:"10%",right:"5%",top:"10%",bottom:"10%",width:"100%"},crosshair:{trigger:"both"},height:450,width:1140},l=new google.visualization.ScatterChart(document.getElementById("frontier_chart"));google.visualization.events.addListener(l,"select",function(t){var a=l.getSelection()[0];a&&(n.range=a.row)}),l.draw(s,r);var n=this;l.draw(s,r),this.frontier=l},RegressionCharts(){for(var t=[["Factor","Beta"]],a=0;a<this.optimization.F;a++){var e=[this.optimization.Factors[a].Name,this.optimization.Regressions[this.range].betas[a]];t.push(e)}var i=new google.visualization.arrayToDataTable(t);new google.visualization.BarChart(document.getElementById("betas")).draw(i,{min:-1,max:1,vAxis:{format:"0.00",scaleType:"log",textStyle:{fontSize:10}},chartArea:{left:"35%",width:"100%"},legend:{position:"none"},colors:["#C28708","#512403","#262602","#BA5004","#465726","#EBD006","#CA9F5D","#996C1A"],title:"Factor Exposures",height:270,width:550,colors:["#1e5adc"]})},drawHistogram(){for(var t=[["Return","Frequency"]],a=0;a<this.basic.HistData.length;a++){var e=[];e.push(this.basic.HistData[a][0]),e.push(this.basic.HistData[a][1]),t.push(e)}var i=google.visualization.arrayToDataTable(t);new google.visualization.ColumnChart(document.getElementById("histogram")).draw(i,{legend:{position:"none"},chartArea:{margin:"auto"},vAxis:{title:"Frequency"},hAxis:{format:"0.00%",title:"Return"},colors:["#1e5adc"],width:1130,height:500})},drawMonthlyChart(){var t=this.basic.Columns;t.unshift("Month"),t.push({type:"boolean",role:"scope"});for(var a=[t],e=0;e<this.basic.Data.length;e++){var i=[],o=this.basic.Data[e][0].year,s=this.basic.Data[e][0].month,r=this.basic.Data[e][0].day;i.push(new Date(o+"-"+s+"-"+r)),i.push(100*this.basic.Data[e][1][0]),i.push(this.basic.Data[e][2]),a.push(i)}var l=google.visualization.arrayToDataTable(a);new google.visualization.LineChart(document.getElementById("monthly_chart")).draw(l,{legend:{position:"none"},chartArea:{margin:"auto"},title:"Cumulative Returns",colors:["#1e5adc"],vAxis:{title:"Return * %"},hAxis:{title:"Time"},height:250})},drawReturns(){for(var t=[["Date",this.basic.Coin.Name,{type:"boolean",role:"scope"},"Adjusted VaR"]],a=0;a<this.basic.HistReturns.length;a++){var e=[],i=this.basic.HistReturns[a][0].year,o=this.basic.HistReturns[a][0].month,s=this.basic.HistReturns[a][0].day;e.push(new Date(i+"-"+o+"-"+s)),e.push(this.basic.HistReturns[a][1]),e.push(this.basic.HistReturns[a][2]),e.push(this.basic.ValueAtRisk),t.push(e)}var r=google.visualization.arrayToDataTable(t);new google.visualization.ComboChart(document.getElementById("histchart")).draw(r,{chartArea:{margin:"auto"},vAxis:{format:"0.00%",title:"Gain"},hAxis:{title:"Time"},title:"Historical Returns",colors:["#1e5adc","#f39800"],width:1130,height:500})},drawMDD(){var t=[];if(0==this.basic.N_Benchmarks){t=[["Date",this.basic.Coin.Name,{type:"boolean",role:"scope"}]];for(var a=0;a<this.basic.UnderWater.length;a++){var e=[],i=this.basic.UnderWater[a][0].year,o=this.basic.UnderWater[a][0].month,s=this.basic.UnderWater[a][0].day;e.push(new Date(i+"-"+o+"-"+s)),e.push(this.basic.UnderWater[a][1]),e.push(this.basic.UnderWater[a][2]),t.push(e)}}else{t=[["Date","coin",this.basic.Benchmarks[0],{type:"boolean",role:"scope"}]];for(a=0;a<this.basic.UnderWater.length;a++){e=[],i=this.basic.UnderWater[a][0].year,o=this.basic.UnderWater[a][0].month,s=this.basic.UnderWater[a][0].day;e.push(new Date(i+"-"+o+"-"+s)),e.push(this.basic.UnderWater[a][1]),e.push(this.basic.UnderWater[a][2]),e.push(this.basic.UnderWater[a][3]),t.push(e)}}var r=google.visualization.arrayToDataTable(t);new google.visualization.LineChart(document.getElementById("underwater")).draw(r,{legend:{position:"none"},chartArea:{margin:"auto"},vAxis:{format:"0.00%",title:"Loss"},hAxis:{title:"Time"},title:"Underwater Curve",colors:["#1e5adc"],width:1130,height:500})},ReturnHistogram(){for(var t=[["Return","Frequency"]],a=0;a<this.ai.ReturnHist.length;a++){var e=[];e.push(this.ai.ReturnHist[a][0]),e.push(this.ai.ReturnHist[a][1]),t.push(e)}var i=google.visualization.arrayToDataTable(t);new google.visualization.ColumnChart(document.getElementById("ret_histogram")).draw(i,{title:"Histogram of Cumulative Returns",vAxis:{title:"Frequency"},hAxis:{format:"0.00%",title:"Return"},legend:{position:"none"},colors:["#1e5adc"],width:1130,height:500})},MDDHistogram(){for(var t=[["Return","Frequency"]],a=0;a<this.ai.MDDHist.length;a++){var e=[];e.push(this.ai.MDDHist[a][0]),e.push(this.ai.MDDHist[a][1]),t.push(e)}var i=google.visualization.arrayToDataTable(t);new google.visualization.ColumnChart(document.getElementById("mdd_histogram")).draw(i,{title:"Histogram of Simulated Drawdowns",vAxis:{title:"Frequency"},hAxis:{format:"0.00%",title:"Loss"},legend:{position:"none"},width:1130,height:500,colors:["#1e5adc"]})},drawTimeLine(){var t=document.getElementById("timeline"),a=new google.visualization.Timeline(t),e=new google.visualization.DataTable;e.addColumn({type:"string",id:"Regime"}),e.addColumn({type:"date",id:"Start"}),e.addColumn({type:"date",id:"End"});var i=[],o=this.percentile;this.ai.Results[o].regime_series.index.forEach(t=>{var a=new Date(t);a.setDate(1);var e=[this.ai.Results[o].regime_series.value[t]+"_"+o,a,new Date(t)];i.push(e)}),e.addRows(i);a.draw(e,{vAxis:{title:"Regime Model"},hAxis:{title:"Time"},title:"Simulated Regimes 99th Percentile",colors:["#1e5adc"],width:815,height:200})},ReturnChart(){var t=this.percentile,a=[["Date","Return"]];this.ai.Results[t].return_series.index.forEach(e=>{var i=[new Date(e),this.ai.Results[t].return_series.value[e]];a.push(i)});var e=new google.visualization.arrayToDataTable(a),i={width:836,legend:{position:"none"},vAxis:{format:"0.00",title:"Return"},hAxis:{title:"Time"},title:`Simulated Returns ${this.percentile}th Percentile`,colors:["#1e5adc"],width:1130,height:500};new google.visualization.ColumnChart(document.getElementById("monthreturn")).draw(e,i)},Betas(){var t=[];t=[["Factor","Beta"]];for(var a=0;a<this.style.Results.N-1;a++){var e=[];e.push(this.style.Results.factor_names[a]),e.push(this.style.Results.reg_analysis.betas[a]),t.push(e)}var i=new google.visualization.arrayToDataTable(t),o=new google.visualization.DataView(i);o.setColumns([0,1]);new google.visualization.BarChart(document.getElementById("betas_div")).draw(o,{min:-1,chartArea:{width:"50%"},max:1,vAxis:{title:"Factor Model"},hAxis:{title:"Beta"},legend:{position:"none"},colors:["#1e5adc"],title:"Factor Exposures",width:1130,height:500})},RSQGauge(){var t=100*this.style.Results.reg_analysis.rsq,a=google.visualization.arrayToDataTable([["Label","Value"],["R-Square",t]]);new google.visualization.Gauge(document.getElementById("rsq_div")).draw(a,{width:400,height:200,redFrom:75,redTo:100,greenFrom:0,greenTo:50,yellowFrom:50,yellowTo:75,majorTicks:10,min:0,max:100})},RollingBetas(){for(var t=[],a=["Date"],e=0;e<this.style.Results.N-1;e++)a.push(this.style.Results.factor_names[e]);a.push({type:"boolean",role:"scope"}),t.push(a),this.style.Results.rolling_reg.forEach(function(a){var e=a[1].betas,i=a[0].year,o=a[0].month,s=a[0].day;e.unshift(new Date(i+"-"+o+"-"+s)),e.push(a[2]),t.push(e)});var i=new google.visualization.arrayToDataTable(t);new google.visualization.LineChart(document.getElementById("rollbeta_div")).draw(i,{legend:{position:"none"},hAxis:{title:"Time"},colors:["#1e5adc"],title:"Rolling Factor Sensitivities",width:1130,height:500})},scatterChart(){for(var t=[["Benchmark","Coin"]],a=0;a<this.style.Results.T;a++){var e=[this.style.Results.common_data.iloc[a][1],this.style.Results.common_data.iloc[a][0]];t.push(e)}var i=new google.visualization.arrayToDataTable(t),o={title:"Portfolio vs. "+this.style.Results.factor_names[0],legend:{position:"none"},colors:["#1e5adc"],width:1130,height:500,vAxis:{format:"0.00%",title:"Portfolio"},hAxis:{format:"0.00%",title:this.style.Results.factor_names[0]+" Factor"}};new google.visualization.ScatterChart(document.getElementById("scatter_div")).draw(i,o)},radarChart(){for(var t=[],a=[],e=0;e<=this.style.Results.N-1;e++){var i=this.style.Results.factor_names[e];t.push(i)}for(e=0;e<=this.style.Results.N-1;e++){i=this.style.Results.reg_analysis.crisk[e];a.push(i)}var o={labels:t,datasets:[{label:"Contribution To Risk",fillColor:"rgba(193,11,11,0.5)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#166f7e",pointHighlightFill:"#166f7e",pointHighlightStroke:"rgba(220,220,220,1)",data:a}]},s=document.getElementById("radarChart").getContext("2d");new Chart(s).Radar(o,{responsive:!0})},RollingCRisk(){for(var t=[],a=["Date"],e=0;e<this.style.Results.N;e++)a.push(this.style.Results.factor_names[e]);t.push(a),this.style.Results.rolling_reg.forEach(a=>{for(var e=a[0],i=a[1],o=[new Date(e.year,e.month,e.day)],s=0;s<this.style.Results.N;s++)o.push(i.crisk[s]);t.push(o)});var i=new google.visualization.arrayToDataTable(t);new google.visualization.AreaChart(document.getElementById("rollcrisk_div")).draw(i,{vAxis:{format:"0.00%",title:"Factors Correlation"},hAxis:{format:"0.00%",title:"Date"},title:"Rolling Factor Risk Contribution",colors:["#1e5adc","#f39800"],legend:{position:"right"},width:1130,height:500})},RiskVsReturnChart(){for(var t=[["Coin","Risk %","Return %"]],a=0;a<this.risk.N;a++){var e=[];e.push(this.risk.Coins[a].Name),e.push(this.risk.crisk[a]),e.push(this.risk.c_ret[a]),t.push(e)}var i=google.visualization.arrayToDataTable(t);new google.visualization.BarChart(document.getElementById("risk_ret_div")).draw(i,{chartArea:{width:"50%"},title:"Risk vs. Return",legend:{position:"right"},colors:["#1e5adc","#f39800"],hAxis:{format:"0.00%"},width:1130,height:500})},MarginalVaRChart(){for(var t=[["Coin","Marginal VaR"]],a=0;a<this.risk.N;a++){var e=[];e.push(this.risk.Coins[a].Name),e.push(this.risk.marginal_vars[a]),t.push(e)}var i=google.visualization.arrayToDataTable(t);new google.visualization.ColumnChart(document.getElementById("marginal_var_div")).draw(i,{chartArea:{width:"50%"},title:"Marginal VaR",legend:{position:"none"},vAxis:{format:"0.00%"},colors:["#1e5adc"],hAxis:{format:"0.00%"},width:1130,height:500})},getPortfolio(){axios.get(window.reqUrl+"/get/portfolio/detail/"+this.url,{params:{token:localStorage.getItem("token")}}).then(t=>{0==t.data.error&&(this.portfolio=t.data.data,google.charts.setOnLoadCallback(this.pie)),403==t.data.error&&(location.href="login.html")}).catch(function(t){console.log(t)})},getOptimization(){this.loading=!0,this.opacity=0,axios.get(window.reqUrl+"/get/reports/portfolio/optimization/"+this.url,{params:{token:localStorage.getItem("token"),risk_fun:this.risk_fun}}).then(t=>{setTimeout(()=>{this.loading=!1,this.opacity=1},1500),0==t.data.error?(this.optimization=t.data.data,this.range=this.optimization.bestFolio,google.charts.setOnLoadCallback(this.frontier_chart),google.charts.setOnLoadCallback(this.RegressionCharts),google.charts.setOnLoadCallback(this.frontierAllocs),google.charts.setOnLoadCallback(this.drawChart)):408==t.data.error&&(location.href="share.html?folio_id="+this.url)}).catch(function(t){console.log(t)})},getBasic(){axios.get(window.reqUrl+"/get/reports/portfolio/basic/"+this.url,{params:{token:localStorage.getItem("token")}}).then(t=>{0==t.data.error&&(this.basic=t.data.data,google.charts.setOnLoadCallback(this.drawMonthlyChart),google.charts.setOnLoadCallback(this.drawHistogram),google.charts.setOnLoadCallback(this.drawReturns),google.charts.setOnLoadCallback(this.drawMDD))}).catch(function(t){console.log(t)})},getAi(){this.loading=!0,this.opacity=0,axios.get(window.reqUrl+"/get/reports/portfolio/ai/"+this.url,{params:{factor_code:this.aiFactor,regime_name:this.aiRegime,n_trials:this.nTrials,token:localStorage.getItem("token")}}).then(t=>{setTimeout(()=>{this.loading=!1,this.opacity=1},1500),0==t.data.error&&(this.ai=t.data.data,google.charts.setOnLoadCallback(this.ReturnHistogram),google.charts.setOnLoadCallback(this.MDDHistogram),google.charts.setOnLoadCallback(this.drawTimeLine),google.charts.setOnLoadCallback(this.ReturnChart))}).catch(function(t){console.log(t)})},percent(){google.charts.setOnLoadCallback(this.drawTimeLine),google.charts.setOnLoadCallback(this.ReturnChart)},getStyle(){this.loading=!0,this.opacity=0,axios.get(window.reqUrl+"/get/reports/portfolio/style/"+this.url,{params:{factor_code:this.styleFactor,token:localStorage.getItem("token")}}).then(t=>{if(setTimeout(()=>{this.loading=!1,this.opacity=1},1500),0==t.data.error){this.style=t.data.data,google.charts.setOnLoadCallback(this.Betas),google.charts.setOnLoadCallback(this.RSQGauge),google.charts.setOnLoadCallback(this.RollingBetas),google.charts.setOnLoadCallback(this.RollingCRisk);for(var a=0;a<this.style.Results.N-1;a++)google.charts.setOnLoadCallback(this.scatterChart);google.charts.setOnLoadCallback(this.radarChart),google.charts.setOnLoadCallback(this.RollingCRisk)}}).catch(function(t){console.log(t)})},getBenchmark(){axios.get(window.reqUrl+"/get/reports/portfolio/benchmark/"+this.url,{params:{token:localStorage.getItem("token")}}).then(t=>{0==t.data.error&&(this.benchmark=t.data.data)}).catch(function(t){console.log(t)})},getRatios(){axios.get(window.reqUrl+"/get/reports/portfolio/ratios/"+this.url,{params:{token:localStorage.getItem("token")}}).then(t=>{0==t.data.error&&(this.ratios=t.data.data)}).catch(function(t){console.log(t)})},getRisk(){axios.get(window.reqUrl+"/get/reports/portfolio/risk/"+this.url,{params:{token:localStorage.getItem("token")}}).then(t=>{0==t.data.error&&(this.risk=t.data.data,google.charts.setOnLoadCallback(this.RiskVsReturnChart),google.charts.setOnLoadCallback(this.MarginalVaRChart))}).catch(function(t){console.log(t)})},getQueryString(t){var a=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),e=window.location.search.substr(1).match(a);return null!=e?unescape(e[2]):null}},created(){this.url=this.getQueryString("folio_id"),google.charts.load("current",{packages:["corechart","controls","bar","timeline","gauge"]}),this.getPortfolio(),this.getOptimization(),this.getBasic(),this.getAi(),this.getStyle(),this.getRatios(),this.getRisk()},computed:{roll(){for(var t=[],a=0;a<this.ratios.RollResults.length;a++){for(var e=[],i=0;i<this.ratios.RollResults[a][1].length;i++)e[this.ratios.RollResults[a][1][i][0]]=this.ratios.RollResults[a][1][i][1];t.push(e)}return t}},watch:{range(){google.charts.setOnLoadCallback(this.drawChart),google.charts.setOnLoadCallback(this.RegressionCharts),this.frontier&&this.frontier.setSelection([{row:this.range,column:1}])}}});
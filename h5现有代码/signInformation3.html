<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>分期公司签订协议</title>
		<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no'>
		<link href="https://cdn.bootcss.com/layer/3.1.0/mobile/need/layer.css" rel="stylesheet">
		<link rel="stylesheet" href="css/common.css" />
		<link href="css/index.css" rel="stylesheet">
	</head>

	<body>
		<div id="app">
			<header class="clearFix" id="header">
				<img class="icon" src="img/Group 6.png" alt="" />
				<p>签订借款协议</p>
			</header>
			<form action="" id="loginForm" method="get">
				<div id="content">
					<div class="workInfo">
						<p class="title"><span>确认放款</span></p>
						<p><span>手机号</span><input id="phone" name="phone" type="text" placeholder="010-1226251"></p>
						<p><span style="float: left">验证码</span><input id="msg" name="msg" style="width: 80px;float: left" type="text" placeholder="请填写验证码">
							<a id="sendMsg" class="sendMsg" href="javascript:;" @click="sendMsg" v-show="show">发送验证码</a>
							<a href="javascript:void(0)" v-show="!show" class="cuntdown" style="display: none;">{{count}}s</a>
						</p>
						<div class="checkDiv">查看
							<a style="vertical-align: middle" href="http://www.baidu.com">《征信授权查询书》</a>
						</div>
					</div>
				</div>
				<footer id="footer">
					<button id="btn">确认</button>
				</footer>
			</form>
		</div>
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/jquery.validate.min.js"></script>
		<script src="https://cdn.bootcss.com/layer/3.1.0/layer.js"></script>
		<script src="js/vue.js"></script>
		<script>
			var vm = new Vue({
				el: '#app',
				data: {
					idName: "",
					idNo: "",
					/*倒计时*/
					show: true,
					count: '',
					timer: null
				},
				created: function() {
					this.query();
				},
				methods: {
					query() {
						var outTradeNo = this.GetQueryString("outTradeNo");
						var bankMobile = this.GetQueryString("bankMobile");
						$("#phone").val(bankMobile);
						localStorage.setItem("outTradeNo", outTradeNo);
						//为了在内部函数能使用外部函数的this对象，要给它赋值了一个名叫self的变量。
						var that = this;
						$.ajax({
							url: 'http://www.trinfi.com/dkh5/inputData/query?outTradeNo=' + outTradeNo,
							type: 'get',
							data: {},
							dataType: 'json'
						}).then(function(res) {
							//把从json获取的数据赋值给数组
							that.idName = res.inputData.idName;
							that.idNo = res.inputData.idNo;
							if(res.isContacts==0){
								location.href="index.html?outTradeNo="+that.GetQueryString("outTradeNo");
							}
							else if(res.fourElements==0){
								location.href="signInformation.html?outTradeNo="+that.GetQueryString("outTradeNo");
							}
							else if(res.creditAuthorization==0){
								location.href="signInformation2.html?outTradeNo="+that.GetQueryString("outTradeNo");
							}
							else{
								//location.href="signInformation3.html?outTradeNo="+that.GetQueryString("outTradeNo");
							}	
						}).fail(function() {
							console.log('失败');
						})
					},
					sendMsg() {
						this.getCode();
						$.ajax({
							url: "http://www.trinfi.com/dkh5/inputData/fourElements",
							type: "post",
							dataType: "json",
							data: {
								outTradeNo: localStorage.outTradeNo,
								bankCardNo: $("#bankCardNo").val(),
								bankCode: $("#bankName").val(),
								bankMobile: $("#phone").val(),
							},
							success: function(message) {
								if(message.static == "0") {
									alert('成功')
								} else {}
							},
							error: function() {
								console.log(1212);
							}
						});
					},
					GetQueryString(name) {
						var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
						var r = window.location.search.substr(1).match(reg); //search,查询？后面的参数，并匹配正则
						if(r != null) return unescape(r[2]);
						return null;
					},
					getCode(){
				     const TIME_COUNT = 60;
				     if (!this.timer) {
				       this.count = TIME_COUNT;
				       this.show = false;
				       this.timer = setInterval(() => {
				       if (this.count > 0 && this.count <= TIME_COUNT) {
				         this.count--;
				        } else {
				         this.show = true;
				         clearInterval(this.timer);
				         this.timer = null;
				        }
				       }, 1000)
				      }
				   }
				}
			})
		</script>
		<script>
			$(function() {
				$("#loginForm").validate({
					rules: {
						msg: {
							required: true,
						},
						phone: {
							required: true,
						},
						cb: {
							required: true,
						},
						cb1: {
							required: true,
						}
					},
					messages: {
						phone: {
							required: "手机号不能为空",
						},
						msg: {
							required: "验证码不能为空",
						},
						cb: {
							required: "请先签署《征信授权查询书》",
						},
						cb1: {
							required: "请先签署《借款协议》"
						}
					},
					errorPlacement: function(error, element) {
						layer.msg(error.text());
					},
					unhighlight: function(element) {},
					submitHandler: function(form) {
						$.ajax({
							url: "http://www.trinfi.com/dkh5/inputData/creditAuthorization",
							type: "post",
							dataType: "json",
							data: {
								outTradeNo: localStorage.outTradeNo,
								type:2
							},
							success: function(message) {
								if(message.static == "0") {
									alert('验证码正确');
									window.location.href = "http://www.trinfi.com/dankeh5/signInformation3.html?outTradeNo=" + localStorage.outTradeNo;
								} else {
									alert('验证码错误')
								}
							},
							error: function() {}
						});
						return;
					},
					onfocusout: function(element) {
						$(element).valid();
					},
					onkeyup: false
				});
			})
		</script>
	</body>

</html>